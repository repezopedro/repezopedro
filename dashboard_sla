import streamlit as st
import pandas as pd
import plotly.express as px
from datetime import timedelta
import numpy as np
import os
import time

# ==============================================================================
# 1. Configura√ß√µes Iniciais e Simula√ß√£o de Dados (para teste)
# ==============================================================================

# Configura√ß√£o da p√°gina do Streamlit
st.set_page_config(
    page_title="Dashboard de Performance de SLA de Pedidos | Supply Chain",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Paleta de cores inspirada em "Bioxxi" (Ciano/Verde e Cinza Profissional)
COLOR_PRIMARY = "#0065D1"  # Azul Ciano
COLOR_SECONDARY = '#3CB371' # Verde Claro
COLOR_TEXT = '#2F4F4F'     # Cinza Escuro (Slate Gray)

# Fun√ß√£o auxiliar para simular o c√°lculo de dias √∫teis (Simplificado)
def add_business_days(date, days_to_add):
    """Calcula a data 'X' dias √∫teis ap√≥s a data inicial (excluindo S√°b/Dom)."""
    if pd.isna(date):
        return pd.NaT
    
    current_date = date
    while days_to_add > 0:
        current_date += timedelta(days=1)
        # 0=Segunda, 6=Domingo
        if current_date.weekday() < 5:  # Se n√£o for S√°bado (5) ou Domingo (6)
            days_to_add -= 1
    return current_date

# Fun√ß√£o para carregar e preparar os dados (AGORA COM NORMALIZA√á√ÉO DE COLUNAS)
@st.cache_data(show_spinner="Carregando e processando dados de SLA...")
def load_data(file_path):
    """Carrega, filtra e prepara os dados da planilha Excel."""
    try:
        df = pd.read_excel(file_path, sheet_name='VIEW_PEDIDOS_SLA')
    except FileNotFoundError:
        st.error(f"Arquivo n√£o encontrado em: {file_path}. Por favor, verifique o caminho.")
        return None
    except ValueError:
        st.error("Planilha 'VIEW_PEDIDOS_SLA' n√£o encontrada no arquivo Excel.")
        return None
    except Exception as e:
        st.error(f"Erro ao carregar os dados: {e}")
        return None

    # 1. NORMALIZA√á√ÉO DE NOMES DE COLUNAS: MAI√öSCULAS e REMOVER ESPA√áOS
    # Isso resolve o KeyError
    df.columns = df.columns.str.strip().str.upper()

    # Vari√°vel de coluna cr√≠tica (usada em todos os c√°lculos CMEXX)
    COLUMN_CMEXX = 'DATA_APROVACAO_CMEXX'
    if COLUMN_CMEXX not in df.columns:
        # Se a coluna n√£o for encontrada ap√≥s a normaliza√ß√£o, gera erro para diagn√≥stico.
        st.error(f"‚ùå ERRO CR√çTICO: Coluna '{COLUMN_CMEXX}' n√£o encontrada.")
        st.warning(f"Nomes de Colunas Encontradas: {list(df.columns)}")
        return None

    # Convers√£o de Tipos de Dados Obrigat√≥ria (Usando nomes normalizados)
    date_cols = ['DTCRIACAO', 'DATACOMPETENCIA', 'DTAPROVACAO', 'DTAPROVACAOGERENCIA',
                 'DTIMPORTACAO', 'DATAEMISSAO', 'DTCONFIRMACAO', 'DTCONFIRMACAOSUPRIMENTOS',
                 COLUMN_CMEXX, 'DATA_PREVISTA_ENTREGA']
    
    # Colunas de ID e Categoria (tamb√©m normalizadas)
    id_cols = ['IDSOLICITACAO', 'NUMEROMOV', 'IDMOV', 'CENTRO_CUSTO', 'PEDIDO_EXTRA', 'STATUS_MOVIMENTO']
    
    # Converte Datas
    for col in date_cols:
        if col in df.columns:
            df[col] = pd.to_datetime(df[col], errors='coerce')
            
    # Converte IDs para String (para garantir 'nunique' correto em Pandas)
    for col in id_cols:
         if col in df.columns:
            df[col] = df[col].astype(str)

    # Exclus√£o de Pedidos Extras (Requisito)
    df = df[df['PEDIDO_EXTRA'] != 'S'].copy()

    # Cria√ß√£o de colunas auxiliares
    df['AnoCriacao'] = df['DTCRIACAO'].dt.year
    df['MesAnoCompetencia'] = df['DATACOMPETENCIA'].dt.to_period('M')

    # KPI 3: Ades√£o √† Cria√ß√£o Mensal (Corte Dia 20)
    df['DiaCriacao'] = df['DTCRIACAO'].dt.day
    df['DentroPrazoCorte'] = (df['DiaCriacao'] <= 20)

    # KPI 4: C√°lculo de SLA CMEXX (2 Dias √öteis ap√≥s DTCRIACAO)
    df['SLA_CMEXX_Lim'] = df.apply(
        lambda row: add_business_days(row['DTCRIACAO'], 2),
        axis=1
    )
    df['SLA_CMEXX_Cumprido'] = df[COLUMN_CMEXX] <= df['SLA_CMEXX_Lim']
    df['SLA_CMEXX_Cumprido'] = df['SLA_CMEXX_Cumprido'].fillna(False)

    # KPI 5: C√°lculo de SLA Importa√ß√£o (2 Dias √öteis ap√≥s DATA_APROVACAO_CMEXX)
    df['SLA_IMP_Lim'] = df.apply(
        lambda row: add_business_days(row[COLUMN_CMEXX], 2),
        axis=1
    )
    df['SLA_IMP_Cumprido'] = df['DTIMPORTACAO'] <= df['SLA_IMP_Lim']
    df['SLA_IMP_Cumprido'] = df['SLA_IMP_Cumprido'].fillna(False)

    return df

# Fun√ß√£o para gerar um DataFrame de exemplo caso o arquivo n√£o exista
def generate_sample_data(num_records: int = 120) -> pd.DataFrame:
    """Gera um DataFrame de exemplo compat√≠vel com o processamento do dashboard.

    A fun√ß√£o cria colunas com os nomes normalizados utilizados no script
    (ex.: 'DTCRIACAO', 'DATACOMPETENCIA', 'IDSOLICITACAO', 'NUMEROMOV', etc.)
    e tamb√©m preenche as colunas derivadas esperadas pelo restante do c√≥digo.
    """
    import random

    # Per√≠odo de cria√ß√£o: √∫ltimos 6 meses
    end = pd.Timestamp.today().normalize()
    start = (end - pd.offsets.MonthBegin(6)).normalize()

    rng = pd.date_range(start=start, end=end, periods=num_records)

    data = {
        'IDSOLICITACAO': [f'SOL-{i//3:04d}' for i in range(num_records)],
        'NUMEROMOV': [f'NMV-{i:05d}' for i in range(num_records)],
        'IDMOV': [f'IMV-{i:06d}' for i in range(num_records)],
        'CENTRO_CUSTO': [random.choice(['CC100','CC200','CC300']) for _ in range(num_records)],
        'PEDIDO_EXTRA': [random.choice(['N','N','N','S']) for _ in range(num_records)],
        'STATUS_MOVIMENTO': [random.choice(['A','B','C']) for _ in range(num_records)],
        'DTCRIACAO': rng,
        # Compet√™ncia: use o primeiro dia do m√™s de cria√ß√£o
        'DATACOMPETENCIA': [pd.Timestamp(d.year, d.month, 1) for d in rng],
        'DATAEMISSAO': rng - pd.to_timedelta(np.random.randint(0, 5, size=num_records), unit='d'),
        'DATA_PREVISTA_ENTREGA': rng + pd.to_timedelta(np.random.randint(3, 30, size=num_records), unit='d'),
        # Simula aprova√ß√£o CMEXX em 0-4 dias √∫teis ap√≥s cria√ß√£o
        'DATA_APROVACAO_CMEXX': [add_business_days(d, int(random.choice([0,1,1,2,3,4]))) for d in rng],
        # Simula data de importacao 0-6 dias √∫teis ap√≥s aprova√ß√£o
        'DTIMPORTACAO': [],
        # Confirma√ß√£o de suprimentos (pode ser NaT para alguns)
        'DTCONFIRMACAOSUPRIMENTOS': [] ,
        # Total (valor) para tabela
        'TOTAL': np.round(np.random.uniform(100.0, 5000.0, size=num_records), 2)
    }

    # Preenche DTIMPORTACAO e DTCONFIRMACAOSUPRIMENTOS com base nas aprova√ß√µes
    for aprov in data['DATA_APROVACAO_CMEXX']:
        # 70% chance de ter importa√ß√£o em 0-4 dias √∫teis, sen√£o NaT
        if pd.isna(aprov) or random.random() < 0.15:
            data['DTIMPORTACAO'].append(pd.NaT)
        else:
            data['DTIMPORTACAO'].append(add_business_days(aprov, int(random.choice([0,1,1,2,3]))))

    for cri in data['DTCRIACAO']:
        # 60% chance de confirma√ß√£o de suprimentos ocorrer antes do fim do m√™s de competencia
        if random.random() < 0.6:
            data['DTCONFIRMACAOSUPRIMENTOS'].append(cri + pd.to_timedelta(np.random.randint(1, 25), unit='d'))
        else:
            data['DTCONFIRMACAOSUPRIMENTOS'].append(pd.NaT)

    df = pd.DataFrame(data)

    # Normaliza colunas (simula o comportamento do load_data)
    df.columns = df.columns.str.strip().str.upper()

    # Garante tipos
    df['DTCRIACAO'] = pd.to_datetime(df['DTCRIACAO'], errors='coerce')
    df['DATACOMPETENCIA'] = pd.to_datetime(df['DATACOMPETENCIA'], errors='coerce')
    df['DATA_APROVACAO_CMEXX'] = pd.to_datetime(df['DATA_APROVACAO_CMEXX'], errors='coerce')
    df['DTIMPORTACAO'] = pd.to_datetime(df['DTIMPORTACAO'], errors='coerce')
    df['DATA_PREVISTA_ENTREGA'] = pd.to_datetime(df['DATA_PREVISTA_ENTREGA'], errors='coerce')

    # Exclui pedidos extras (mant√©m consist√™ncia com load_data flows)
    df = df[df['PEDIDO_EXTRA'] != 'S'].copy()

    # Colunas derivadas
    df['AnoCriacao'] = df['DTCRIACAO'].dt.year
    df['MesAnoCompetencia'] = df['DATACOMPETENCIA'].dt.to_period('M')
    df['DiaCriacao'] = df['DTCRIACAO'].dt.day
    df['DENTROPRAZOCORTE'] = (df['DiaCriacao'] <= 20)

    # SLA CMEXX limite e cumprimento (nomes em MAI√öSCULAS)
    df['SLA_CMEXX_LIM'] = df['DTCRIACAO'].apply(lambda d: add_business_days(d, 2) if not pd.isna(d) else pd.NaT)
    df['SLA_CMEXX_CUMPRIDO'] = (df['DATA_APROVACAO_CMEXX'] <= df['SLA_CMEXX_LIM']).fillna(False)

    # SLA importa√ß√£o (nomes em MAI√öSCULAS)
    df['SLA_IMP_LIM'] = df['DATA_APROVACAO_CMEXX'].apply(lambda d: add_business_days(d, 2) if not pd.isna(d) else pd.NaT)
    df['SLA_IMP_CUMPRIDO'] = (df['DTIMPORTACAO'] <= df['SLA_IMP_LIM']).fillna(False)

    # Ajuste de nomes para compatibilidade com restante do script
    # O restante do script cria/espera colunas com case mista (ex: 'SLA_CMEXX_Lim')
    # Para evitar KeyErrors quando usamos os dados de simula√ß√£o, criamos aliases.
    df['SLA_CMEXX_Lim'] = df['SLA_CMEXX_LIM']
    df['SLA_CMEXX_Cumprido'] = df['SLA_CMEXX_CUMPRIDO']
    df['SLA_IMP_Lim'] = df['SLA_IMP_LIM']
    df['SLA_IMP_Cumprido'] = df['SLA_IMP_CUMPRIDO']

    # Ajuste de nome para 'DentroPrazoCorte' com capitaliza√ß√£o esperada
    df = df.rename(columns={'DENTROPRAZOCORTE': 'DentroPrazoCorte'})

    return df

# ==============================================================================
# 2. Fun√ß√µes de C√°lculo das M√©tricas (KPIs)
# ==============================================================================

def calculate_kpi_adesao_corte(df):
    """KPI 3: % de Pedidos Criados no Prazo de Corte (Dia 20) - Base IdSolicitacao."""
    if df.empty:
        return 0.0

    # Usa IDSOLICITACAO (Normalizado)
    grouped = df.groupby('IDSOLICITACAO').first().reset_index()

    total_pedidos = grouped['IDSOLICITACAO'].nunique()
    pedidos_no_prazo = grouped[grouped['DentroPrazoCorte'] == True]['IDSOLICITACAO'].nunique()

    return (pedidos_no_prazo / total_pedidos) if total_pedidos > 0 else 0.0

def calculate_kpi_sla_cmexx(df):
    """KPI 4: % de Aprova√ß√µes CMEXX no Prazo (2 Dias √öteis) - Base IdSolicitacao."""
    if df.empty:
        return 0.0

    grouped = df.groupby('IDSOLICITACAO').first().reset_index()

    total_pedidos = grouped['IDSOLICITACAO'].nunique()
    pedidos_no_prazo = grouped[grouped['SLA_CMEXX_Cumprido'] == True]['IDSOLICITACAO'].nunique()

    return (pedidos_no_prazo / total_pedidos) if total_pedidos > 0 else 0.0

def calculate_kpi_sla_importacao(df):
    """KPI 5: % de Importa√ß√µes no Prazo (2 Dias √öteis) - Base IdSolicitacao."""
    if df.empty:
        return 0.0

    grouped = df.groupby('IDSOLICITACAO').first().reset_index()

    total_pedidos = grouped['IDSOLICITACAO'].nunique()
    pedidos_no_prazo = grouped[grouped['SLA_IMP_Cumprido'] == True]['IDSOLICITACAO'].nunique()

    return (pedidos_no_prazo / total_pedidos) if total_pedidos > 0 else 0.0

def plot_kpi_eficiencia_entrega(df):
    """KPI 2: % de Pedidos Entregues no Prazo de Compet√™ncia (Gr√°fico de Linha/Barra) - Base NUMEROMOV."""
    if df.empty:
        st.info("Nenhum dado para o per√≠odo selecionado.")
        return

    df_unique = df.groupby('NUMEROMOV').first().reset_index()
    df_unique['MesAnoCompetencia_str'] = df_unique['DATACOMPETENCIA'].dt.to_period('M').astype(str)
    
    df_unique['EntregueNoPrazo'] = df_unique['DTCONFIRMACAOSUPRIMENTOS'] <= df_unique['DATACOMPETENCIA']

    grouped_final = df_unique.groupby('MesAnoCompetencia_str').agg(
        Total_Pedidos=('NUMEROMOV', 'nunique'),
        Pedidos_Entregues=('EntregueNoPrazo', 'sum')
    ).reset_index().sort_values('MesAnoCompetencia_str')

    grouped_final['Percentual_SLA'] = (grouped_final['Pedidos_Entregues'] / grouped_final['Total_Pedidos']) * 100
    grouped_final = grouped_final.fillna(0)

    fig = px.line(
        grouped_final,
        x='MesAnoCompetencia_str',
        y='Percentual_SLA',
        title='% de Pedidos Entregues no Prazo de Compet√™ncia',
        markers=True,
        template="plotly_white",
        color_discrete_sequence=[COLOR_PRIMARY]
    )
    fig.update_traces(hovertemplate='%{y:.2f}%<extra></extra>')
    fig.update_yaxes(title="Percentual (%)", tickformat=".0f", range=[0, 100])
    fig.update_xaxes(title="M√™s/Ano de Compet√™ncia")
    st.plotly_chart(fig, use_container_width=True)


# --- NOVAS FUN√á√ïES DE DETALHE ---

def calculate_adesao_by_month(df):
    """Calcula o % de Pedidos Criados no Prazo de Corte (Dia 20) M√äS A M√äS."""
    if df.empty:
        return pd.DataFrame()

    df_unique = df.groupby('IDSOLICITACAO').first().reset_index()
    df_unique['MesAnoCriacao_str'] = df_unique['DTCRIACAO'].dt.to_period('M').astype(str)

    grouped = df_unique.groupby('MesAnoCriacao_str').agg(
        Total_Pedidos=('IDSOLICITACAO', 'nunique'),
        Pedidos_No_Prazo=('DentroPrazoCorte', 'sum')
    ).reset_index().sort_values('MesAnoCriacao_str')
    
    grouped['Percentual_Adesao'] = (grouped['Pedidos_No_Prazo'] / grouped['Total_Pedidos']) * 100
    grouped = grouped.fillna(0)

    return grouped

def plot_adesao_by_month(df_monthly):
    """Gera o gr√°fico de linha para Ades√£o Mensal ao Prazo de Corte."""
    if df_monthly.empty:
        st.warning("Nenhum dado mensal para plotar.")
        return

    fig = px.line(
        df_monthly,
        x='MesAnoCriacao_str',
        y='Percentual_Adesao',
        title='Ades√£o Mensal ao Prazo de Corte (Dia 20)',
        markers=True,
        template="plotly_white",
        color_discrete_sequence=[COLOR_SECONDARY]
    )
    fig.update_traces(hovertemplate='**M√™s:** %{x}<br>**Ades√£o:** %{y:.2f}%<extra></extra>')
    fig.update_yaxes(title="Percentual (%)", tickformat=".0f", range=[0, 100])
    fig.update_xaxes(title="M√™s/Ano de Cria√ß√£o")
    st.plotly_chart(fig, use_container_width=True)

# ==============================================================================
# 3. Layout e Execu√ß√£o do Dashboard
# ==============================================================================

def display_kpi_card(title, value, help_text=None):
    """Exibe um Cart√£o de KPI formatado no Streamlit."""
    if help_text:
        st.markdown(f"<span style='font-size: 1em;'>**{title}**</span> <sup title='{help_text}' style='font-size: 0.7em;'>‚ìò</sup>", unsafe_allow_html=True)
    else:
        st.markdown(f"**{title}**")
    
    st.markdown(f"<p style='font-size: 2em; color: {COLOR_TEXT}; margin-bottom: 0px;'>{value:.2%}</p>", unsafe_allow_html=True)
    st.markdown("---")


def main_dashboard():
    """Fun√ß√£o principal para montar o dashboard."""
    
    # Inicializa o estado da sess√£o para controle de tela
    if 'page' not in st.session_state:
        st.session_state.page = 'main'
    
    # DEFINI√á√ÉO DO CAMINHO DO ARQUIVO (ATUALIZADO)
    file_path = r'C:\Users\pedro.muniz\Documents\pythonlocal\BIOXXI\INDICADORESCMEXXFAB\CMEXXFAB_SQL.xlsx'
    
    # O Streamlit usa o cache, ent√£o a carga √© r√°pida se o arquivo n√£o mudar.
    if os.path.exists(file_path):
        df_base = load_data(file_path)
    else:
        st.warning(f"Arquivo n√£o encontrado no caminho: `{file_path}`. Usando dados de simula√ß√£o gerados localmente.")
        # Gera dados de exemplo para permitir testes locais sem o arquivo Excel.
        df_base = generate_sample_data()

    if df_base is None or df_base.empty:
        # Se o load_data falhar (ex: coluna n√£o encontrada ap√≥s normaliza√ß√£o), ele retorna None
        st.stop()
    
    # --- Sidebar de Filtros (KPI 1) --- (Mantido)
    st.sidebar.header("Filtros de An√°lise")
    all_years = sorted(df_base['AnoCriacao'].dropna().unique().astype(int).tolist(), reverse=True)
    
    if not all_years:
        st.sidebar.warning("Nenhum ano de cria√ß√£o encontrado nos dados v√°lidos.")
        st.stop()

    selected_years = st.sidebar.multiselect(
        "Selecione o(s) Ano(s) de Cria√ß√£o:",
        options=all_years,
        default=all_years[:2] if len(all_years) > 1 else all_years
    )

    if not selected_years:
        st.sidebar.warning("Selecione pelo menos um ano.")
        st.stop()

    df_filtered = df_base[df_base['AnoCriacao'].isin(selected_years)].copy() # Use copy() ap√≥s filtragem
    
    all_cc = sorted(df_base['CENTRO_CUSTO'].dropna().unique().tolist())
    selected_cc = st.sidebar.multiselect(
        "Filtro por Centro de Custo:",
        options=all_cc,
        default=[] 
    )
    
    if selected_cc:
        df_filtered = df_filtered[df_filtered['CENTRO_CUSTO'].isin(selected_cc)]
        
    st.sidebar.info(f"Total de Pedidos na Vis√£o: **{df_filtered['IDSOLICITACAO'].nunique():,}**")
    
    # ------------------------------------
    
    # L√≥gica de Navega√ß√£o
    if st.session_state.page == 'main':
        st.title("Performance Entrega de Insumos")
        st.markdown(f"<span style='color:{COLOR_TEXT}; font-size: 0.9em;'>An√°lise de Efici√™ncia de Aprova√ß√£o, Importa√ß√£o e Entrega.</span>", unsafe_allow_html=True)
        st.markdown("---")
        
        # 1. Linha dos Cart√µes de KPI
        st.subheader("Indicadores Chave de SLA (Per√≠odo Filtrado)")
        col_kpi1, col_kpi2, col_kpi3, col_kpi_total = st.columns(4)

        # KPI 3: Ades√£o √† Cria√ß√£o Mensal (Corte Dia 20) - COM BOT√ÉO DE DETALHE
        kpi_adesao = calculate_kpi_adesao_corte(df_filtered)
        with col_kpi1:
            display_kpi_card(
                "Ades√£o ao Prazo de Cria√ß√£o | Opera√ß√µes",
                kpi_adesao,
                help_text="Porcentagem de Pedidos (IdSolicitacao) criados at√© o dia 20 do m√™s de cria√ß√£o."
            )
            # BOT√ÉO PARA DETALHE
            if st.button('üìà Ver Tend√™ncia Mensal', key='btn_detalhe_adesao', use_container_width=True):
                st.session_state.page = 'detalhe_adesao'
                st.rerun()

        # KPI 4: SLA de Aprova√ß√£o CMEXX (2 Dias √öteis)
        kpi_cmexx = calculate_kpi_sla_cmexx(df_filtered)
        with col_kpi2:
            display_kpi_card(
                "SLA Aprova√ß√£o CMEXX",
                kpi_cmexx,
                help_text="Porcentagem de Pedidos (IdSolicitacao) com aprova√ß√£o CMEXX em at√© 2 dias √∫teis da cria√ß√£o."
            )

        # KPI 5: SLA de Importa√ß√£o (2 Dias √öteis)
        kpi_importacao = calculate_kpi_sla_importacao(df_filtered)
        with col_kpi3:
            display_kpi_card(
                "SLA de Importa√ß√£o",
                kpi_importacao,
                help_text="Porcentagem de Pedidos (IdSolicitacao) com Importa√ß√£o em at√© 2 dias √∫teis da aprova√ß√£o CMEXX."
            )
            
        # Cart√£o de Total de Pedidos
        with col_kpi_total:
            st.markdown(f"**Total de Pedidos**")
            st.markdown(f"<p style='font-size: 2em; color: {COLOR_TEXT}; margin-bottom: 0px;'>{df_filtered['IDSOLICITACAO'].nunique():,}</p>", unsafe_allow_html=True)
            st.markdown("---")

        # 2. Gr√°fico de Tend√™ncia (KPI 2)
        st.subheader("Tend√™ncia Mensal de Efici√™ncia de Entrega")
        plot_kpi_eficiencia_entrega(df_filtered)
        st.markdown("---")
        
        # 3. Tabela de Acompanhamento (KPI 6)
        st.subheader("Acompanhamento Detalhado de Previs√£o de Entrega")
        
        cols_table = ['IDMOV', 'IDSOLICITACAO', 'NUMEROMOV', 'CENTRO_CUSTO', 'DATAEMISSAO',
                      'DATA_PREVISTA_ENTREGA', 'STATUS_MOVIMENTO', 'DTCRIACAO', 'TOTAL']
        
        cols_to_display = [col for col in cols_table if col in df_filtered.columns]
        
        df_table = df_filtered[cols_to_display].sort_values('DTCRIACAO', ascending=False).head(500)
        
        st.dataframe(
            df_table,
            use_container_width=True,
            hide_index=True,
            column_config={
                "TOTAL": st.column_config.NumberColumn("Total (R$)", format="R$ %.2f"),
                "DTCRIACAO": st.column_config.DateColumn("Cria√ß√£o", format="DD/MM/YYYY"),
                "DATAEMISSAO": st.column_config.DateColumn("Emiss√£o", format="DD/MM/YYYY"),
                "DATA_PREVISTA_ENTREGA": st.column_config.DateColumn("Prev. Entrega", format="DD/MM/YYYY"),
            }
        )

        st.markdown("***")
        st.markdown("*Nota do Arquiteto:* Este √© o *MVP*. O pr√≥ximo passo seria a inclus√£o de uma tabela de feriados para um c√°lculo de dias √∫teis 100% preciso.")

    # --- Tela de Detalhe do KPI 3 ---
    elif st.session_state.page == 'detalhe_adesao':
        st.title("üîé Detalhe: Ades√£o Mensal ao Prazo para Aprova√ß√£o (At√© oDia 20)")
        
        # BOT√ÉO DE RETORNO
        if st.button('‚¨ÖÔ∏è Voltar ao Dashboard Principal', key='btn_voltar', type='primary'):
            st.session_state.page = 'main'
            st.rerun()

        st.markdown("---")
        
        # C√°lculo e Plotagem do Detalhe
        df_mensal = calculate_adesao_by_month(df_filtered)
        
        if not df_mensal.empty:
            plot_adesao_by_month(df_mensal)
            
            st.subheader("Dados de Suporte")
            st.dataframe(df_mensal, use_container_width=True, hide_index=True)
        else:
            st.info("Nenhum dado encontrado para o c√°lculo mensal no per√≠odo filtrado.")

if __name__ == '__main__':
    main_dashboard()
